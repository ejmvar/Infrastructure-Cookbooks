# nginx + passenger application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#

# Permanent redirect 80 => 443
server {
  listen 80;
  rewrite ^(.*) https://$host$1 permanent;
}

server {
  listen 443 ssl;
  server_name '<%= @fqdn %>';

  root <%= @docroot %>;
  error_log <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;
  passenger_enabled on;
  rails_env <%= @rails_env %>;

  # SSL config.
  ssl                  on;
  ssl_certificate      /etc/ssl/<%= @fqdn %>.fullcert;
  ssl_certificate_key  /etc/ssl/<%= @fqdn %>.key;
  ssl_protocols        SSLv3 TLSv1; # Do not allow SSLv2
  ssl_ciphers          ALL:!aNULL:!ADH:!eNULL:!LOW:!MEDIUM:!EXP:RC4+RSA:+HIGH;
  ssl_prefer_server_ciphers on;
  ssl_session_timeout  5m;
  ssl_session_cache shared:SSL:10m; # Reuse session => less handshakes => better perfs
}

